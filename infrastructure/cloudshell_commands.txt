# Run these commands in Cloud Shell to apply the payments schema

# 1. Get the database password
DB_PASSWORD=$(gcloud secrets versions access latest --secret='advotecate-dev-db-password' --project=advotecate-dev)
echo "Password retrieved: ${#DB_PASSWORD} characters"

# 2. Start Cloud SQL Proxy in background
cloud_sql_proxy -instances=advotecate-dev:us-central1:advotecate-dev-postgres=tcp:5432 &
PROXY_PID=$!
echo "Proxy started with PID: $PROXY_PID"

# 3. Wait for proxy to be ready
sleep 10
echo "Proxy should be ready now"

# 4. Apply the payments schema
echo "Applying payments schema..."
PGPASSWORD="$DB_PASSWORD" psql "postgresql://advotecate_app_dev@localhost:5432/advotecate_payments_dev" -f ~/payments_schema.sql

# 5. Verify tables were created
echo "Verifying tables..."
PGPASSWORD="$DB_PASSWORD" psql "postgresql://advotecate_app_dev@localhost:5432/advotecate_payments_dev" -c "
SELECT schemaname, tablename, hasindexes, hasrules, hastriggers
FROM pg_tables
WHERE schemaname IN ('payments', 'compliance')
ORDER BY schemaname, tablename;
"

# 6. Test sample data
echo "Checking sample data..."
PGPASSWORD="$DB_PASSWORD" psql "postgresql://advotecate_app_dev@localhost:5432/advotecate_payments_dev" -c "
SELECT COUNT(*) as contribution_limits_count FROM compliance.contribution_limits;
"

# 7. Clean up
kill $PROXY_PID
echo "Schema application complete!"

# If you need to run individual commands for troubleshooting:
# PGPASSWORD="$DB_PASSWORD" psql "postgresql://advotecate_app_dev@localhost:5432/advotecate_payments_dev" -c "\l"  # List databases
# PGPASSWORD="$DB_PASSWORD" psql "postgresql://advotecate_app_dev@localhost:5432/advotecate_payments_dev" -c "\dn" # List schemas